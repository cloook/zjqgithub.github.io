<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>
    HashMap源码分析 |
    
    yang的博客</title>
  
    <link rel="shortcut icon" href="/favicon.ico">
  
  <link rel="stylesheet" href="/css/style.css">
  
    <link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">
  
  <script src="/js/pace.min.js"></script>
</head>
</html>
<body>
<main class="content">
  <section class="outer">
  <article id="post-HashMap源码分析" class="article article-type-post" itemscope itemprop="blogPost">

  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      HashMap源码分析
    </h1>
  

      </header>
    

    
      <div class="article-meta">
        <a href="/2018/08/11/HashMap源码分析/" class="article-date">
  <time datetime="2018-08-11T13:54:02.000Z" itemprop="datePublished">2018-08-11</time>
</a>
        
      </div>
    

    <div class="article-entry" itemprop="articleBody">
      
      
      
        <h3 id="关于HashMap-自己的回顾"><a href="#关于HashMap-自己的回顾" class="headerlink" title="关于HashMap 自己的回顾"></a>关于HashMap 自己的回顾</h3><p>数据结构原型：</p>
<p><strong>数组+链表</strong></p>
<p><img src="/2018/08/11/HashMap源码分析/hashmap1.png" alt="RT"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">class Node &#123;</span><br><span class="line">    key,</span><br><span class="line">    value,</span><br><span class="line">    next</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先根据hash算法，得出hash值，放在 Node[] 中，当 hash值相同时，往下依次排列，当单链表长度达到一定值时，单链表转成红黑树（jdk 1.8）。</p>
<p><strong>计算hash值：</strong></p>
<p>Object.hashCode() 对 Node[] 的size 取模<br><strong>源码里采用位运算，效率更高</strong><br>hashMap 默认长度是 1&lt;&lt;4 = 2^4 = 16<br>所以取模运算等同于 hash &amp; (16-1)<br>可以得出 0-15的索引值，即Node[]的索引位置</p>
<p><strong>&amp; 运算</strong></p>
<p>111010101001111<br>&amp;<br>01111</p>
<p><hr><br>结果一定是在 00000~01111之间，即0-15</p>
<p>考虑到哈希碰撞结果的不稳定性，hash算法进行优化</p>
<p>Object.hashCode()^Object.hashCode()&gt;&gt;&gt;16</p>
<p>hashCode的高16位和低16位进行与或运算，是一个合适的散列分布<br><strong>为什么是16呢</strong>，因为hashCode是int<br>拿这个结果再 &amp; (Node[].size()-1) 得出的索引值是比较均匀合理的</p>
<p><strong>Node[] 扩容</strong></p>
<p>每次计算完哈希值之后，去Node[] 排坑，如果坑位还没有被占用，就填进去，顺便 ++占位值；<br>当占位置 &gt; Node[].size() * 默认科学计量值(0.75)的时候，就该扩容了</p>
<p>扩容每次扩充两倍，map的size有上限，最大值是 2^32<br><strong>为什么是2倍呢？</strong><br>这还是回到哈希算法中，我们用到了 &amp; 运算来计算最后的hash值，也就是Node[]的size一定要是2的n次幂才是合适的<br><strong>为什么是2的n次幂呢？</strong><br>因为任何2的n次幂一定是 1000…  这种结构的然后 Node[].size() -1 就是 0111… 这种结构的<br>0111…这种结构才能够保证Node[]数组的每一个索引值都有可能被用到，不会造成空闲位置的资源浪费</p>
<p><strong>Node[] 扩容之后</strong></p>
<p>Node[] 扩容之后，要重新计算hash值，对已存在的Node进行迁移<br><strong>Node[]上任意节点的迁移一定是原地不动或者 index+扩充长度</strong><br>为什么这样呢，<br>因为我们扩充2倍之后，等于加了一位，比如原来是16 = 10000，现在变成了 32 = 100000 在重新计算hash值的时候，&amp; 运算由01111 变成了 011111<br>  &nbsp;&nbsp;01111<br>011111<br>可以看出 后面四个1保证了后四位&amp;运算结果不会变化，然后再往左一位结果可能是0也可能是1，如果是0那就是原地不动，如果是1，那就是index+扩展长度</p>
<p>以上 🙂</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/08/11/HashMap源码分析/" data-id="cjsmu9vea0001hcqep3gr9q2r" class="article-share-link">Share</a>
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li></ul>

    </footer>

  </div>

  
    
  <nav class="article-nav">
    
      <a href="/2019/02/22/spring切面编程/" class="article-nav-link">
        <strong class="article-nav-caption">Newer posts</strong>
        <div class="article-nav-title">
          
            spring切面编程
          
        </div>
      </a>
    
    
      <a href="/2018/08/10/vue国际化/" class="article-nav-link">
        <strong class="article-nav-caption">Olde posts</strong>
        <div class="article-nav-title">vue国际化</div>
      </a>
    
  </nav>


  

  
    
  

</article>



</section>
  <footer class="footer">
  
  <div class="outer">
    <ul class="list-inline">
      <li>&copy; 2019 yang的博客</li>
      <li>Powered by <a href="http://hexo.io/" target="_blank">Hexo</a></li>
      <li>Theme  <a href="https://zhwangart.github.io">zhwangart</a></li>
      <li><i class="fe fe-bar-chart"></i> <span id="busuanzi_value_site_pv"></span></li>
      <li><i class="fe fe-smile-alt"></i> <span id="busuanzi_value_site_uv"></span></li>
    </ul>
  </div>
</footer>
</main>
<aside class="sidebar">
  <button class="navbar-toggle"></button>

<nav class="navbar">
  
    <div class="logo">
      <a href="/"><img src="/images/hexo.svg" alt="yang的博客"></a>
    </div>
  
  <ul class="nav nav-main">
    
      <li class="nav-item">
        <a class="nav-item-link" href="/">Home</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/archives">Archives</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/gallery">Gallery</a>
      </li>
    
      <li class="nav-item">
        <a class="nav-item-link" href="/about">About</a>
      </li>
    
    <li class="nav-item">
      <a class="nav-item-link nav-item-search" title="Search">
        <i class="fe fe-search"></i>
        Search
      </a>
    </li>
  </ul>
</nav>

<nav class="navbar navbar-bottom">
  <ul class="nav">
    <li class="nav-item">
      
        <a class="nav-item-link" target="_blank" href="/atom.xml" title="RSS Feed">
          <i class="fe fe-feed"></i>
        </a>
      
    </li>
  </ul>
</nav>

<div class="search-form-wrap">
  <div class="local-search local-search-plugin">
  <input type="search" id="local-search-input" class="local-search-input" placeholder="Search...">
  <div id="local-search-result" class="local-search-result"></div>
</div>
</div>
</aside>
  <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/lazyload.min.js"></script>
<script src="/js/busuanzi-2.3.pure.min.js"></script>


  <script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/ocean.js"></script>

</body>
</html>